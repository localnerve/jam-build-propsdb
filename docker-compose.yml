# Main Compose - propsdb, database, authorizer, cache
# Database and fragments are mixed in based on DB_TYPE from data/compose/ yaml files
# This is used for production, development, and testing
name: jam-build-propsdb
services:
  # PropsDB Go Fiber Service
  propsdb:
    build:
      context: .
      dockerfile: Dockerfile
    image: jam-build-propsdb
    container_name: propsdb-api
    ports:
      - "${PORT}:${PORT}"
    environment:
      - PORT=${PORT}
      - DB_TYPE=${DB_TYPE}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_APP_DATABASE=${DB_APP_DATABASE}
      - DB_APP_USER=${DB_APP_USER}
      - DB_APP_PASSWORD=${DB_APP_PASSWORD}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_APP_CONNECTION_LIMIT=${DB_APP_CONNECTION_LIMIT}
      - DB_CONNECTION_LIMIT=${DB_CONNECTION_LIMIT}
      - AUTHZ_URL=${AUTHZ_URL}
      - AUTHZ_CLIENT_ID=${AUTHZ_CLIENT_ID}
    healthcheck:
      test: ["CMD", "/app/healthcheck"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    depends_on:
      database:
        condition: service_healthy
      authorizer:
        condition: service_started
    networks:
      - propsdb-network
    restart: unless-stopped


  # The cache - Used by authorizer for session storage
  cache:
    image: redis:8.4.0
    container_name: propsdb-cache
    ports:
      - 6379:6379
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - cache:/data
    networks:
      - propsdb-network
    restart: unless-stopped

  # Authorizer Service
  authorizer:
    image: localnerve/authorizer:1.5.3
    container_name: propsdb-authorizer
    ports:
      - "${AUTHZ_PORT}:${AUTHZ_PORT}"
    environment:
      - ENV=production
      - PORT=${AUTHZ_PORT}
      - ADMIN_SECRET=${AUTHZ_ADMIN_SECRET}
      - CLIENT_ID=${AUTHZ_CLIENT_ID}
      - ORGANIZATION_NAME=${AUTHZ_ORGANIZATION_NAME}
      - ORGANIZATION_LOGO=${AUTHZ_ORGANIZATION_LOGO}
      - ROLES=user,admin
      - REDIS_URL=redis://cache:6379
    depends_on:
      database:
        condition: service_healthy
      cache:
        condition: service_started
    networks:
      - propsdb-network
    restart: unless-stopped

  # Optional: Adminer for database management
  adminer:
    image: adminer:4.8.1
    container_name: propsdb-adminer
    ports:
      - "8081:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=database
    depends_on:
      - database
    networks:
      - propsdb-network
    restart: unless-stopped

networks:
  propsdb-network:
    driver: bridge

volumes:
  dbdata:
  cache:
  backup:
