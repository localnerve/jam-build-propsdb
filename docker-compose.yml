# PropsDB Fullstack Docker Compose - propsdb, database, authorizer, cache
# PropsDB depends on the authorizer and a database service
# This is used for development, testing, and as a reference for how to use propsDB in an application
name: propsdb
services:
  # PropsDB Go Fiber Service
  propsdb:
    build:
      context: .
      dockerfile: Dockerfile
    image: propsdb
    container_name: propsdb-api
    ports:
      - "${PORT}:${PORT}"
    environment:
      - PORT=${PORT}
      - DB_TYPE=${DB_TYPE}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_APP_DATABASE=${DB_APP_DATABASE}
      - DB_APP_USER=${DB_APP_USER}
      - DB_APP_PASSWORD=${DB_APP_PASSWORD}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_APP_CONNECTION_LIMIT=${DB_APP_CONNECTION_LIMIT}
      - DB_CONNECTION_LIMIT=${DB_CONNECTION_LIMIT}
      - AUTHZ_URL=${AUTHZ_URL}
      - AUTHZ_CLIENT_ID=${AUTHZ_CLIENT_ID}
    depends_on:
      database:
        condition: service_healthy
      authorizer:
        condition: service_started
    networks:
      - propsdb-network
    restart: unless-stopped

  # Database Service
  database:
    image: ${DB_IMAGE}
    container_name: propsdb-database
    ports:
      - "${DB_PORT}:${DB_PORT}"
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_APP_DATABASE}
      - MYSQL_USER=${DB_APP_USER}
      - MYSQL_PASSWORD=${DB_APP_PASSWORD}
      - AUTHZ_DATABASE=${AUTHZ_DATABASE}     # Added for init script
      - DB_USER=${DB_USER}                   # Added for init script
      - DB_PASSWORD=${DB_PASSWORD}           # Added for init script
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - dbdata:/var/lib/mysql
      - ./data/initdb/${DB_TYPE}:/docker-entrypoint-initdb.d
      # - ./data/migrations/${DB_TYPE}:/docker-entrypoint-migrations.d
    networks:
      - propsdb-network
    restart: unless-stopped

  # The cache - Used by authorizer for session storage
  cache:
    image: redis:8.4.0
    container_name: propsdb-cache
    ports:
      - 6379:6379
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - cache:/data
    networks:
      - propsdb-network
    restart: unless-stopped

  # Authorizer Service
  authorizer:
    image: localnerve/authorizer:1.5.3
    container_name: propsdb-authorizer
    ports:
      - "${AUTHZ_PORT}:${AUTHZ_PORT}"
    environment:
      - ENV=production
      - DATABASE_TYPE=${DB_TYPE}
      - DATABASE_URL=root:${DB_ROOT_PASSWORD}@tcp(database:${DB_PORT})/${AUTHZ_DATABASE}
      - PORT=${AUTHZ_PORT}
      - ADMIN_SECRET=${AUTHZ_ADMIN_SECRET}
      - DATABASE_NAME=${AUTHZ_DATABASE}
      - CLIENT_ID=${AUTHZ_CLIENT_ID}
      - ORGANIZATION_NAME=${AUTHZ_ORGANIZATION_NAME}
      - ORGANIZATION_LOGO=${AUTHZ_ORGANIZATION_LOGO}
      - ROLES=user,admin
      - REDIS_URL=redis://cache:6379
    depends_on:
      database:
        condition: service_healthy
    networks:
      - propsdb-network
    restart: unless-stopped

  # Optional: Adminer for database management
  adminer:
    image: adminer:4.8.1
    container_name: propsdb-adminer
    ports:
      - "8081:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=mariadb
    networks:
      - propsdb-network
    restart: unless-stopped

networks:
  propsdb-network:
    driver: bridge

volumes:
  dbdata:
  cache:
  backup:
